---
# Django deployment for Ubuntu 24.04
#
# PREREQUISITES:
#   1. Run disableroot.yml first to create deploy user and disable root
#   2. Update group_vars/all with your settings
#
# USAGE:
#   cd ansible
#   ansible-playbook -i servers djangodeployubuntu24.yml
#
# For first deployment, add --tags=first_run to run migrations:
#   ansible-playbook -i servers djangodeployubuntu24.yml --tags=all,first_run
#
# Required variables in group_vars/all:
#   - deploy_user, ansible_user: the deploy account
#   - location: project directory name
#   - projectname: used for nginx/supervisor configs
#   - domain: your domain name
#   - githuburl: repository URL
#   - db_name, db_user, db_password: PostgreSQL credentials

- hosts: all
  tasks:
    # =========================================================================
    # System Updates and Package Installation
    # =========================================================================
    - name: Update apt cache
      become: true
      apt:
        update_cache: true
        cache_valid_time: 3600

    - name: Install required system packages
      become: true
      apt:
        pkg:
          # Core tools
          - vim
          - htop
          - unzip
          - git
          - curl
          - wget
          # Python
          - python3
          - python3-dev
          - python3-pip
          - python3-venv
          # Build tools
          - build-essential
          - libffi-dev
          - libssl-dev
          # Web server
          - nginx
          - certbot
          - python3-certbot-nginx
          # Process management
          - supervisor
          # Database
          - postgresql
          - postgresql-contrib
          - libpq-dev
          # Cache
          - redis-server
          # For Ansible PostgreSQL modules
          - python3-psycopg2
        state: present

    - name: Ensure services are running
      become: true
      service:
        name: "{{ item }}"
        state: started
        enabled: true
      loop:
        - postgresql
        - redis-server
        - nginx
        - supervisor

    # =========================================================================
    # PostgreSQL Database Setup
    # =========================================================================
    - name: Create PostgreSQL database
      become: true
      become_user: postgres
      community.postgresql.postgresql_db:
        name: "{{ db_name }}"
        state: present
      tags: [first_run, never]

    - name: Create PostgreSQL user
      become: true
      become_user: postgres
      community.postgresql.postgresql_user:
        name: "{{ db_user }}"
        password: "{{ db_password }}"
        state: present
      tags: [first_run, never]

    - name: Grant database privileges
      become: true
      become_user: postgres
      community.postgresql.postgresql_privs:
        database: "{{ db_name }}"
        roles: "{{ db_user }}"
        type: database
        privs: ALL
        state: present
      tags: [first_run, never]

    # =========================================================================
    # Project Directory Setup
    # =========================================================================
    - name: Create /home/www directory
      become: true
      file:
        path: /home/www
        state: directory
        owner: "{{ deploy_user }}"
        group: "{{ deploy_user }}"
        mode: '0755'

    - name: Check if project directory exists
      stat:
        path: /home/www/{{ location }}
      register: project_dir

    - name: Clone repository (first time)
      become: true
      become_user: "{{ deploy_user }}"
      git:
        repo: "{{ githuburl }}"
        dest: /home/www/{{ location }}
        version: main
        accept_hostkey: true
      when: not project_dir.stat.exists
      environment:
        GIT_TERMINAL_PROMPT: "0"

    - name: Pull latest changes (subsequent runs)
      become: true
      become_user: "{{ deploy_user }}"
      git:
        repo: "{{ githuburl }}"
        dest: /home/www/{{ location }}
        version: main
        update: true
        accept_hostkey: true
      when: project_dir.stat.exists
      environment:
        GIT_TERMINAL_PROMPT: "0"

    # =========================================================================
    # Python Virtual Environment
    # =========================================================================
    - name: Create virtual environment
      become: true
      become_user: "{{ deploy_user }}"
      command: python3 -m venv /home/www/{{ location }}/venv
      args:
        creates: /home/www/{{ location }}/venv/bin/python

    - name: Upgrade pip in virtualenv
      become: true
      become_user: "{{ deploy_user }}"
      pip:
        name: pip
        state: latest
        virtualenv: /home/www/{{ location }}/venv

    - name: Install Python requirements
      become: true
      become_user: "{{ deploy_user }}"
      pip:
        requirements: /home/www/{{ location }}/requirements.txt
        virtualenv: /home/www/{{ location }}/venv

    # =========================================================================
    # Log Directory
    # =========================================================================
    - name: Create log directory
      become: true
      file:
        path: /var/log/{{ projectname }}
        state: directory
        owner: "{{ deploy_user }}"
        group: "{{ deploy_user }}"
        mode: '0755'

    # =========================================================================
    # Nginx Configuration
    # =========================================================================
    - name: Remove default nginx site
      become: true
      file:
        path: /etc/nginx/sites-enabled/default
        state: absent

    - name: Upload nginx configuration
      become: true
      template:
        src: files/nginx.conf.j2
        dest: /etc/nginx/sites-available/{{ projectname }}.conf
        mode: '0644'

    - name: Enable nginx site
      become: true
      file:
        src: /etc/nginx/sites-available/{{ projectname }}.conf
        dest: /etc/nginx/sites-enabled/{{ projectname }}.conf
        state: link
        force: true

    - name: Test nginx configuration
      become: true
      command: nginx -t
      register: nginx_test
      changed_when: false

    - name: Reload nginx
      become: true
      service:
        name: nginx
        state: reloaded

    # =========================================================================
    # Supervisor Configuration
    # =========================================================================
    - name: Upload supervisor configuration
      become: true
      template:
        src: files/supervisor.conf.j2
        dest: /etc/supervisor/conf.d/{{ projectname }}.conf
        mode: '0644'

    - name: Reload supervisor configuration
      become: true
      command: supervisorctl reread
      changed_when: false

    - name: Update supervisor
      become: true
      command: supervisorctl update
      changed_when: false

    - name: Restart application
      become: true
      supervisorctl:
        name: "{{ projectname }}"
        state: restarted

    # =========================================================================
    # Django Setup (first run only)
    # =========================================================================
    - name: Run Django collectstatic
      become: true
      become_user: "{{ deploy_user }}"
      command: /home/www/{{ location }}/venv/bin/python manage.py collectstatic --noinput
      args:
        chdir: /home/www/{{ location }}
      tags: [first_run, never]

    - name: Run Django migrations
      become: true
      become_user: "{{ deploy_user }}"
      command: /home/www/{{ location }}/venv/bin/python manage.py migrate --noinput
      args:
        chdir: /home/www/{{ location }}
      tags: [first_run, never]

    - name: Load initial languages
      become: true
      become_user: "{{ deploy_user }}"
      command: /home/www/{{ location }}/venv/bin/python manage.py set_languages
      args:
        chdir: /home/www/{{ location }}
      tags: [first_run, never]

    # =========================================================================
    # Firewall Setup (first run only)
    # =========================================================================
    - name: Install UFW
      become: true
      apt:
        name: ufw
        state: present
      tags: [first_run, never]

    - name: Allow SSH through firewall
      become: true
      ufw:
        rule: allow
        name: OpenSSH
      tags: [first_run, never]

    - name: Allow HTTP through firewall
      become: true
      ufw:
        rule: allow
        port: '80'
        proto: tcp
      tags: [first_run, never]

    - name: Allow HTTPS through firewall
      become: true
      ufw:
        rule: allow
        port: '443'
        proto: tcp
      tags: [first_run, never]

    - name: Enable UFW
      become: true
      ufw:
        state: enabled
        policy: deny
      tags: [first_run, never]

    # =========================================================================
    # Final Status
    # =========================================================================
    - name: Print deployment status
      debug:
        msg: |
          Deployment complete!

          Application: {{ projectname }}
          Domain: {{ domain }}
          Logs: /var/log/{{ projectname }}/

          Next steps:
          - Set up SSL: sudo certbot --nginx -d {{ domain }}
          - Create config.py on the server
          - Run migrations: manage.py migrate
          - Create superuser: manage.py createsuperuser
