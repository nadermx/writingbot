{% extends "base.html" %}
{% load static %}

{% block head %}
<!-- Structured data for SEO -->
<script type="application/ld+json">
{
    "@context": "https://schema.org",
    "@type": "WebApplication",
    "name": "{{ source_fmt.name }} to {{ target_fmt.name }} Converter",
    "url": "{{ request.build_absolute_uri }}",
    "applicationCategory": "UtilityApplication",
    "operatingSystem": "Any",
    "offers": {
        "@type": "Offer",
        "price": "0",
        "priceCurrency": "USD"
    },
    "description": "{{ seo.meta_description }}"
}
</script>
<script type="application/ld+json">
{
    "@context": "https://schema.org",
    "@type": "HowTo",
    "name": "How to Convert {{ source_fmt.name }} to {{ target_fmt.name }}",
    "step": [
        {% for step in seo.steps %}
        {
            "@type": "HowToStep",
            "position": {{ step.step }},
            "name": "{{ step.title }}",
            "text": "{{ step.text }}"
        }{% if not forloop.last %},{% endif %}
        {% endfor %}
    ]
}
</script>
<script type="application/ld+json">
{
    "@context": "https://schema.org",
    "@type": "FAQPage",
    "mainEntity": [
        {% for faq in seo.faqs %}
        {
            "@type": "Question",
            "name": "{{ faq.q }}",
            "acceptedAnswer": {
                "@type": "Answer",
                "text": "{{ faq.a|striptags }}"
            }
        }{% if not forloop.last %},{% endif %}
        {% endfor %}
    ]
}
</script>
{% endblock %}

{% block content %}
<!-- Hero Section -->
<div class="bg-light py-5">
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-lg-8 text-center">
                <h1 class="display-5 fw-bold mb-3">{{ seo.h1 }}</h1>
                <p class="lead text-muted mb-0">{{ seo.subtitle }}</p>
            </div>
        </div>
    </div>
</div>

<!-- Converter Tool -->
<div class="container py-5" x-data="converterTool()" x-init="init()">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="card border-0 shadow-sm">
                <div class="card-body p-4">

                    <!-- Upload Area -->
                    <div x-show="!fileUploaded" class="text-center py-5"
                         @dragover.prevent="dragging = true"
                         @dragleave.prevent="dragging = false"
                         @drop.prevent="handleDrop($event)"
                         :class="dragging ? 'border-primary bg-light' : 'border-secondary'"
                         style="border: 2px dashed #dee2e6; border-radius: 12px; cursor: pointer;"
                         @click="$refs.fileInput.click()">
                        <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" fill="#6c757d" viewBox="0 0 24 24" class="mb-3">
                            <path d="M9 16h6v-6h4l-7-7-7 7h4v6zm-4 2h14v2H5v-2z"/>
                        </svg>
                        <p class="mb-1 fw-semibold">Drop your {{ source_fmt.name }} file here or click to browse</p>
                        <p class="text-muted small mb-0">Upload a {{ source_fmt.full_name }} to convert to {{ target_fmt.name }}</p>
                        <input type="file" x-ref="fileInput" @change="handleFileSelect($event)" accept="{{ accept }}" class="d-none">
                    </div>

                    <!-- File Uploaded: Preview + Convert -->
                    <div x-show="fileUploaded">
                        <div class="d-flex align-items-center justify-content-between mb-3 pb-3 border-bottom">
                            <div class="d-flex align-items-center gap-2">
                                <span class="badge bg-secondary">{{ source_fmt.name }}</span>
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="#6c757d" viewBox="0 0 24 24"><path d="M12 4l-1.41 1.41L16.17 11H4v2h12.17l-5.58 5.59L12 20l8-8-8-8z"/></svg>
                                <span class="badge bg-primary">{{ target_fmt.name }}</span>
                                <span class="fw-semibold ms-2" x-text="fileName"></span>
                            </div>
                            <button class="btn btn-sm btn-outline-secondary" @click="resetTool()">Change File</button>
                        </div>

                        <!-- Image Preview -->
                        {% if conv_type == 'image-to-image' %}
                        <div x-show="previewUrl" class="text-center mb-3">
                            <img :src="previewUrl" class="img-fluid rounded" style="max-height: 300px;">
                        </div>

                        <!-- Quality slider for lossy targets -->
                        {% if target_key == 'jpg' or target_key == 'webp' or target_key == 'avif' %}
                        <div class="row mb-3 justify-content-center">
                            <div class="col-md-6">
                                <label class="form-label fw-semibold">Quality</label>
                                <input type="range" class="form-range" x-model="quality" min="10" max="100" step="5">
                                <div class="form-text text-center" x-text="quality + '%'"></div>
                            </div>
                        </div>
                        {% endif %}
                        {% endif %}

                        <!-- Convert Button -->
                        <button class="btn btn-primary btn-lg w-100" @click="convert()" :disabled="processing">
                            <span x-show="!processing">Convert to {{ target_fmt.name }}</span>
                            <span x-show="processing">
                                <span class="spinner-border spinner-border-sm me-2"></span>Converting...
                            </span>
                        </button>
                    </div>

                    <!-- Error -->
                    <div x-show="error" class="alert alert-danger mt-3" x-text="error"></div>

                    <!-- Download Result -->
                    <div x-show="downloadReady" class="text-center mt-4 pt-4 border-top">
                        <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" fill="#198754" viewBox="0 0 24 24" class="mb-3">
                            <path d="M9 16.2L4.8 12l-1.4 1.4L9 19 21 7l-1.4-1.4L9 16.2z"/>
                        </svg>
                        <p class="fw-semibold mb-3">Your {{ target_fmt.name }} file is ready!</p>

                        <!-- Image result preview -->
                        <div x-show="resultPreviewUrl" class="mb-3">
                            <img :src="resultPreviewUrl" class="img-fluid rounded" style="max-height: 300px;">
                        </div>

                        <a :href="downloadUrl" class="btn btn-success btn-lg" download>
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 24 24" class="me-2"><path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/></svg>
                            Download {{ target_fmt.name }}
                        </a>

                        <div class="mt-3">
                            <button class="btn btn-outline-primary btn-sm" @click="resetTool()">Convert Another File</button>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>
</div>

<!-- How to Convert Steps -->
<div class="bg-light py-5">
    <div class="container">
        <h2 class="text-center fw-bold mb-5">How to Convert {{ source_fmt.name }} to {{ target_fmt.name }}</h2>
        <div class="row g-4 justify-content-center">
            {% for step in seo.steps %}
            <div class="col-md-4">
                <div class="text-center">
                    <div class="d-inline-flex align-items-center justify-content-center rounded-circle bg-primary text-white fw-bold mb-3" style="width: 48px; height: 48px; font-size: 1.25rem;">
                        {{ step.step }}
                    </div>
                    <h5 class="fw-semibold mb-2">{{ step.title }}</h5>
                    <p class="text-muted small mb-0">{{ step.text }}</p>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</div>

<!-- Features Section -->
<div class="container py-5">
    <h2 class="text-center fw-bold mb-5">Why Use Our {{ source_fmt.name }} to {{ target_fmt.name }} Converter?</h2>
    <div class="row g-4">
        {% for feature in seo.features %}
        <div class="col-md-4">
            <div class="card h-100 border-0 shadow-sm p-4">
                <div class="mb-3">
                    {% if feature.icon == 'quality' %}
                    <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" fill="#6366f1" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/></svg>
                    {% elif feature.icon == 'speed' %}
                    <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" fill="#6366f1" viewBox="0 0 24 24"><path d="M11.99 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2zM12 20c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8zm.5-13H11v6l5.25 3.15.75-1.23-4.5-2.67z"/></svg>
                    {% elif feature.icon == 'security' %}
                    <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" fill="#6366f1" viewBox="0 0 24 24"><path d="M18 8h-1V6c0-2.76-2.24-5-5-5S7 3.24 7 6v2H6c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V10c0-1.1-.9-2-2-2zm-6 9c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2zm3.1-9H8.9V6c0-1.71 1.39-3.1 3.1-3.1 1.71 0 3.1 1.39 3.1 3.1v2z"/></svg>
                    {% endif %}
                </div>
                <h5 class="fw-semibold mb-3">{{ feature.title }}</h5>
                <p class="text-muted mb-0">{{ feature.text }}</p>
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<!-- About This Conversion -->
<div class="bg-light py-5">
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-lg-8">
                <h2 class="fw-bold mb-4">About {{ source_fmt.name }} and {{ target_fmt.name }} Formats</h2>
                <div class="row g-4">
                    <div class="col-md-6">
                        <div class="card border-0 shadow-sm p-4 h-100">
                            <h5 class="fw-semibold mb-2">{{ source_fmt.full_name }} ({{ source_fmt.extension }})</h5>
                            <p class="text-muted small mb-0">{{ source_fmt.description }}</p>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card border-0 shadow-sm p-4 h-100">
                            <h5 class="fw-semibold mb-2">{{ target_fmt.full_name }} ({{ target_fmt.extension }})</h5>
                            <p class="text-muted small mb-0">{{ target_fmt.description }}</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- FAQ Section -->
<div class="container py-5">
    <h2 class="text-center fw-bold mb-5">Frequently Asked Questions</h2>
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="accordion" id="faqAccordion">
                {% for faq in seo.faqs %}
                <div class="accordion-item border-0 mb-2">
                    <h3 class="accordion-header">
                        <button class="accordion-button {% if not forloop.first %}collapsed{% endif %} fw-semibold"
                                type="button" data-bs-toggle="collapse"
                                data-bs-target="#faq{{ forloop.counter }}">
                            {{ faq.q }}
                        </button>
                    </h3>
                    <div id="faq{{ forloop.counter }}"
                         class="accordion-collapse collapse {% if forloop.first %}show{% endif %}"
                         data-bs-parent="#faqAccordion">
                        <div class="accordion-body text-muted">
                            {{ faq.a|safe }}
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<!-- Related Conversions -->
{% if other_pairs %}
<div class="bg-light py-5">
    <div class="container">
        <h2 class="text-center fw-bold mb-5">Other Popular File Conversions</h2>
        <div class="row g-2 justify-content-center">
            {% for pair in other_pairs %}
            <div class="col-auto">
                <a href="{{ pair.url }}" class="btn btn-outline-secondary btn-sm">
                    {{ pair.source_name }} to {{ pair.target_name }}
                </a>
            </div>
            {% endfor %}
        </div>
        <div class="text-center mt-4">
            <a href="/convert/" class="btn btn-primary">View All Converters</a>
        </div>
    </div>
</div>
{% endif %}

{% endblock %}

{% block scripts %}
<script>
// Converter configuration injected from Django
window.CONVERTER_CONFIG = {
    sourceKey: '{{ source_key }}',
    targetKey: '{{ target_key }}',
    sourceName: '{{ source_fmt.name }}',
    targetName: '{{ target_fmt.name }}',
    convType: '{{ conv_type }}',
    apiEndpoint: '{{ api_config.endpoint }}',
    apiMethod: '{{ api_config.method }}',
    accept: '{{ accept }}',
    targetFormat: '{{ api_config.target_format }}',
    {% if api_config.direction %}
    direction: '{{ api_config.direction }}',
    {% endif %}
};
</script>
<script src="{% static 'js/converter.js' %}?v={{ g.scripts_version }}"></script>
{% endblock %}
