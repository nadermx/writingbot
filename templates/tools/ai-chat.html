{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="container py-4" style="max-width: 896px;">
    <!-- Header -->
    <div class="text-center mb-4">
        <h1 class="display-5 fw-bold text-dark">AI Chat</h1>
        <p class="mt-2 text-muted">Chat with an AI writing assistant. Get help with brainstorming, grammar, outlines, and more.</p>
    </div>

    {% csrf_token %}

    <div x-data="aiChat()" x-cloak>

        <!-- Usage Badge -->
        <div class="d-flex justify-content-center mb-3">
            {% if not is_premium %}
            <div class="d-inline-flex align-items-center gap-2 px-3 py-1 bg-light rounded-pill small text-secondary">
                <svg style="width:16px;height:16px" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>
                <span x-text="remaining >= 0 ? remaining + ' / {{ limit }} messages today' : 'Unlimited'"></span>
            </div>
            {% else %}
            <div class="d-inline-flex align-items-center gap-2 px-3 py-1 bg-brand-50 rounded-pill small text-brand">
                <svg style="width:16px;height:16px" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>
                Premium - Unlimited messages
            </div>
            {% endif %}
        </div>

        <!-- Chat Container -->
        <div class="card shadow-sm rounded-4 overflow-hidden d-flex flex-column" style="height: 600px;">

            <!-- Messages Area -->
            <div class="flex-grow-1 overflow-auto p-3" id="chat-messages" x-ref="messagesContainer">

                <!-- Welcome Message -->
                <div x-show="messages.length === 0" class="d-flex flex-column align-items-center justify-content-center h-100 text-center px-3">
                    <div class="bg-brand-50 rounded-4 d-flex align-items-center justify-content-center mb-3" style="width:64px;height:64px;">
                        <svg style="width:32px;height:32px" class="text-brand" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/></svg>
                    </div>
                    <h3 class="fs-5 fw-semibold text-dark mb-2">How can I help you write today?</h3>
                    <p class="text-muted small mb-4" style="max-width: 28rem;">Ask me to brainstorm ideas, improve your writing, explain grammar rules, create outlines, or anything else writing-related.</p>

                    <!-- Suggestion Chips -->
                    <div class="d-flex flex-wrap justify-content-center gap-2">
                        <button @click="sendSuggestion('Help me brainstorm ideas for a blog post about productivity')"
                                class="btn btn-light btn-sm text-body">
                            Brainstorm blog ideas
                        </button>
                        <button @click="sendSuggestion('Explain the difference between active and passive voice')"
                                class="btn btn-light btn-sm text-body">
                            Grammar help
                        </button>
                        <button @click="sendSuggestion('Create an outline for a research paper about climate change')"
                                class="btn btn-light btn-sm text-body">
                            Create an outline
                        </button>
                        <button @click="sendSuggestion('How can I make my writing more engaging and less boring?')"
                                class="btn btn-light btn-sm text-body">
                            Improve my writing
                        </button>
                    </div>
                </div>

                <!-- Message Bubbles -->
                <template x-for="(msg, index) in messages" :key="index">
                    <div :class="msg.role === 'user' ? 'd-flex justify-content-end mb-3' : 'd-flex justify-content-start mb-3'">
                        <div :class="msg.role === 'user'
                            ? 'bg-brand text-white rounded-4 px-3 py-2'
                            : 'bg-light text-dark rounded-4 px-3 py-2'"
                            style="max-width:80%;border-bottom-right-radius:0.375rem !important;"
                            :style="msg.role !== 'user' ? 'border-bottom-left-radius:0.375rem !important;border-bottom-right-radius:var(--bs-border-radius-xl) !important;' : ''">
                            <!-- User messages: plain text -->
                            <div x-show="msg.role === 'user'" class="small" style="line-height:1.6;white-space:pre-wrap;" x-text="msg.content"></div>
                            <!-- Assistant messages: rendered markdown -->
                            <div x-show="msg.role === 'assistant'" class="small" style="line-height:1.6;" x-html="renderMarkdown(msg.content)"></div>
                        </div>
                    </div>
                </template>

                <!-- Typing Indicator -->
                <div x-show="loading" class="d-flex justify-content-start mb-3">
                    <div class="bg-light rounded-4 px-3 py-2" style="border-bottom-left-radius:0.375rem !important;">
                        <div class="d-flex gap-1 align-items-center">
                            <div class="bg-secondary rounded-circle animate-bounce" style="width:8px;height:8px;opacity:0.5;animation-delay:0ms;"></div>
                            <div class="bg-secondary rounded-circle animate-bounce" style="width:8px;height:8px;opacity:0.5;animation-delay:150ms;"></div>
                            <div class="bg-secondary rounded-circle animate-bounce" style="width:8px;height:8px;opacity:0.5;animation-delay:300ms;"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Error Message -->
            <div x-show="error" class="px-3 py-2 border-top" style="background-color:#fef2f2;border-color:#fee2e2 !important;">
                <p class="small text-danger mb-0" x-text="error"></p>
            </div>

            <!-- Input Area -->
            <div class="border-top p-3 bg-light">
                <div class="d-flex gap-3 align-items-end">
                    <div class="flex-grow-1 position-relative">
                        <textarea
                            x-model="inputMessage"
                            @keydown.enter.prevent="if (!$event.shiftKey) sendMessage()"
                            @input="autoResize($event.target)"
                            placeholder="Type your message... (Shift+Enter for new line)"
                            rows="1"
                            class="form-control rounded-3"
                            style="max-height: 120px; resize: none; overflow: hidden;"
                            :disabled="loading"
                        ></textarea>
                    </div>
                    <button
                        @click="sendMessage()"
                        :disabled="loading || !inputMessage.trim()"
                        class="btn btn-brand flex-shrink-0 d-flex align-items-center justify-content-center rounded-3"
                        style="width:44px;height:44px;"
                    >
                        <svg x-show="!loading" style="width:20px;height:20px" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/></svg>
                        <svg x-show="loading" style="width:20px;height:20px" class="animate-spin" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                    </button>
                </div>
                <div class="d-flex justify-content-between align-items-center mt-2">
                    <button @click="clearChat()" x-show="messages.length > 0"
                            class="btn btn-link btn-sm text-secondary text-decoration-none p-0" style="font-size:0.75rem;">
                        Clear conversation
                    </button>
                    <span style="font-size:0.75rem;" class="text-secondary">Press Enter to send</span>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Why Use Section -->
<div class="bg-light py-5">
    <div class="container">
        <h2 class="text-center fw-bold mb-5">Why Use Our AI Chat</h2>
        <div class="row g-4">
            <div class="col-md-4">
                <div class="card h-100 border-0 shadow-sm p-4">
                    <h5 class="fw-semibold mb-3">Writing-Focused AI</h5>
                    <p class="text-muted mb-0">Unlike general chatbots, our AI assistant specializes in writing tasks: brainstorming, grammar help, outlining, editing advice, and creative writing assistance.</p>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card h-100 border-0 shadow-sm p-4">
                    <h5 class="fw-semibold mb-3">Conversation Memory</h5>
                    <p class="text-muted mb-0">Your chat history is saved locally so you can continue conversations across sessions. Pick up right where you left off.</p>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card h-100 border-0 shadow-sm p-4">
                    <h5 class="fw-semibold mb-3">Markdown Rendering</h5>
                    <p class="text-muted mb-0">AI responses are rendered with full markdown support including headers, lists, bold, italic, and code blocks for well-formatted writing help.</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- How to Use Section -->
<div class="container py-5">
    <h2 class="text-center fw-bold mb-5">How to Use AI Chat</h2>
    <div class="row g-4 justify-content-center">
        <div class="col-md-4 text-center">
            <div class="rounded-circle bg-primary text-white d-inline-flex align-items-center justify-content-center mb-3" style="width:48px;height:48px;font-size:1.25rem;font-weight:700;">1</div>
            <h5 class="fw-semibold">Start a Conversation</h5>
            <p class="text-muted">Type your writing question or use one of the suggested prompts like brainstorming, grammar help, or outline creation.</p>
        </div>
        <div class="col-md-4 text-center">
            <div class="rounded-circle bg-primary text-white d-inline-flex align-items-center justify-content-center mb-3" style="width:48px;height:48px;font-size:1.25rem;font-weight:700;">2</div>
            <h5 class="fw-semibold">Chat Naturally</h5>
            <p class="text-muted">Have a back-and-forth conversation with the AI. It remembers your previous messages for context-aware responses.</p>
        </div>
        <div class="col-md-4 text-center">
            <div class="rounded-circle bg-primary text-white d-inline-flex align-items-center justify-content-center mb-3" style="width:48px;height:48px;font-size:1.25rem;font-weight:700;">3</div>
            <h5 class="fw-semibold">Apply the Advice</h5>
            <p class="text-muted">Use the AI's suggestions to improve your writing. Copy responses or continue the conversation for more detailed help.</p>
        </div>
    </div>
</div>

<!-- FAQ Section -->
<div class="container py-5">
    <h2 class="text-center fw-bold mb-5">Frequently Asked Questions</h2>
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="accordion" id="faqAccordion">
                <div class="accordion-item border-0 mb-2">
                    <h3 class="accordion-header">
                        <button class="accordion-button fw-semibold" type="button" data-bs-toggle="collapse" data-bs-target="#faq1">
                            What can I ask the AI chat?
                        </button>
                    </h3>
                    <div id="faq1" class="accordion-collapse collapse show" data-bs-parent="#faqAccordion">
                        <div class="accordion-body text-muted">You can ask about brainstorming ideas, grammar rules, writing techniques, creating outlines, improving clarity, adjusting tone, structuring essays, writing cover letters, and any other writing-related topic. The AI is specifically trained to assist with writing tasks.</div>
                    </div>
                </div>
                <div class="accordion-item border-0 mb-2">
                    <h3 class="accordion-header">
                        <button class="accordion-button collapsed fw-semibold" type="button" data-bs-toggle="collapse" data-bs-target="#faq2">
                            How many messages can I send per day?
                        </button>
                    </h3>
                    <div id="faq2" class="accordion-collapse collapse" data-bs-parent="#faqAccordion">
                        <div class="accordion-body text-muted">Free users get a daily message limit shown in the usage badge at the top. Premium subscribers get unlimited messages with no daily caps.</div>
                    </div>
                </div>
                <div class="accordion-item border-0 mb-2">
                    <h3 class="accordion-header">
                        <button class="accordion-button collapsed fw-semibold" type="button" data-bs-toggle="collapse" data-bs-target="#faq3">
                            Does it remember my previous messages?
                        </button>
                    </h3>
                    <div id="faq3" class="accordion-collapse collapse" data-bs-parent="#faqAccordion">
                        <div class="accordion-body text-muted">Yes, within the same conversation the AI remembers everything you have discussed. Your conversation history is also saved locally in your browser so you can resume it later.</div>
                    </div>
                </div>
                <div class="accordion-item border-0 mb-2">
                    <h3 class="accordion-header">
                        <button class="accordion-button collapsed fw-semibold" type="button" data-bs-toggle="collapse" data-bs-target="#faq4">
                            Can it write entire essays for me?
                        </button>
                    </h3>
                    <div id="faq4" class="accordion-collapse collapse" data-bs-parent="#faqAccordion">
                        <div class="accordion-body text-muted">The AI can help you brainstorm, outline, draft, and revise your writing, but it works best as a writing assistant rather than a replacement for your own work. Use it to get ideas, overcome writer's block, and improve your drafts.</div>
                    </div>
                </div>
                <div class="accordion-item border-0 mb-2">
                    <h3 class="accordion-header">
                        <button class="accordion-button collapsed fw-semibold" type="button" data-bs-toggle="collapse" data-bs-target="#faq5">
                            Is the AI the same as ChatGPT?
                        </button>
                    </h3>
                    <div id="faq5" class="accordion-collapse collapse" data-bs-parent="#faqAccordion">
                        <div class="accordion-body text-muted">Our AI chat uses different AI models optimized for writing assistance. While similar in capability, it is specifically tuned for writing-related tasks like grammar help, style advice, and content creation.</div>
                    </div>
                </div>
                <div class="accordion-item border-0 mb-2">
                    <h3 class="accordion-header">
                        <button class="accordion-button collapsed fw-semibold" type="button" data-bs-toggle="collapse" data-bs-target="#faq6">
                            Does it support markdown in responses?
                        </button>
                    </h3>
                    <div id="faq6" class="accordion-collapse collapse" data-bs-parent="#faqAccordion">
                        <div class="accordion-body text-muted">Yes, AI responses are rendered with full markdown support including headings, bullet lists, numbered lists, bold text, italic text, and code blocks. This makes the output easy to read and well-formatted.</div>
                    </div>
                </div>
                <div class="accordion-item border-0 mb-2">
                    <h3 class="accordion-header">
                        <button class="accordion-button collapsed fw-semibold" type="button" data-bs-toggle="collapse" data-bs-target="#faq7">
                            Can I clear my chat history?
                        </button>
                    </h3>
                    <div id="faq7" class="accordion-collapse collapse" data-bs-parent="#faqAccordion">
                        <div class="accordion-body text-muted">Yes, click the "Clear conversation" link at the bottom of the chat to start fresh. This removes all messages from your current session and local storage.</div>
                    </div>
                </div>
                <div class="accordion-item border-0 mb-2">
                    <h3 class="accordion-header">
                        <button class="accordion-button collapsed fw-semibold" type="button" data-bs-toggle="collapse" data-bs-target="#faq8">
                            Is my conversation private?
                        </button>
                    </h3>
                    <div id="faq8" class="accordion-collapse collapse" data-bs-parent="#faqAccordion">
                        <div class="accordion-body text-muted">Your conversation history is stored locally in your browser and is not accessible to other users. Messages are sent to our servers for processing but are not stored permanently.</div>
                    </div>
                </div>
                <div class="accordion-item border-0 mb-2">
                    <h3 class="accordion-header">
                        <button class="accordion-button collapsed fw-semibold" type="button" data-bs-toggle="collapse" data-bs-target="#faq9">
                            How is this different from the AI Search tool?
                        </button>
                    </h3>
                    <div id="faq9" class="accordion-collapse collapse" data-bs-parent="#faqAccordion">
                        <div class="accordion-body text-muted">AI Chat is designed for back-and-forth conversations about writing topics, while AI Search provides researched answers with source references. Use Chat for interactive brainstorming and Search for factual research questions.</div>
                    </div>
                </div>
                <div class="accordion-item border-0 mb-2">
                    <h3 class="accordion-header">
                        <button class="accordion-button collapsed fw-semibold" type="button" data-bs-toggle="collapse" data-bs-target="#faq10">
                            Can I use it on mobile?
                        </button>
                    </h3>
                    <div id="faq10" class="accordion-collapse collapse" data-bs-parent="#faqAccordion">
                        <div class="accordion-body text-muted">Yes, the chat interface is fully responsive and works well on smartphones and tablets. The input area and message bubbles adjust to your screen size.</div>
                    </div>
                </div>
                <div class="accordion-item border-0 mb-2">
                    <h3 class="accordion-header">
                        <button class="accordion-button collapsed fw-semibold" type="button" data-bs-toggle="collapse" data-bs-target="#faq11">
                            Does it work in languages other than English?
                        </button>
                    </h3>
                    <div id="faq11" class="accordion-collapse collapse" data-bs-parent="#faqAccordion">
                        <div class="accordion-body text-muted">The AI chat works best in English but can understand and respond in many other languages. Writing-specific advice like grammar rules and style tips are most accurate for English.</div>
                    </div>
                </div>
                <div class="accordion-item border-0 mb-2">
                    <h3 class="accordion-header">
                        <button class="accordion-button collapsed fw-semibold" type="button" data-bs-toggle="collapse" data-bs-target="#faq12">
                            Is there an API for the AI chat?
                        </button>
                    </h3>
                    <div id="faq12" class="accordion-collapse collapse" data-bs-parent="#faqAccordion">
                        <div class="accordion-body text-muted">Currently, the AI chat is only available through the web interface. We do not offer a public API for the chat functionality.</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- Marked.js for Markdown rendering -->
<script src="https://cdn.jsdelivr.net/npm/marked@12/marked.min.js"></script>
<script>
function aiChat() {
    return {
        inputMessage: '',
        messages: [],
        loading: false,
        error: '',
        remaining: {{ remaining }},

        init() {
            // Restore conversation from localStorage
            var saved = localStorage.getItem('writingbot_ai_chat');
            if (saved) {
                try {
                    this.messages = JSON.parse(saved);
                } catch (e) {
                    this.messages = [];
                }
            }
            this.$nextTick(() => { this.scrollToBottom(); });
        },

        saveMessages() {
            try {
                // Keep only last 50 messages in storage
                var toSave = this.messages.slice(-50);
                localStorage.setItem('writingbot_ai_chat', JSON.stringify(toSave));
            } catch (e) {
                // Storage full, clear old data
                localStorage.removeItem('writingbot_ai_chat');
            }
        },

        scrollToBottom() {
            var container = this.$refs.messagesContainer;
            if (container) {
                container.scrollTop = container.scrollHeight;
            }
        },

        autoResize(el) {
            el.style.height = 'auto';
            el.style.height = Math.min(el.scrollHeight, 120) + 'px';
        },

        renderMarkdown(text) {
            if (!text) return '';
            try {
                if (typeof marked !== 'undefined') {
                    return marked.parse(text);
                }
            } catch (e) {}
            // Fallback: escape HTML and convert newlines to <br>
            return text.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/\n/g, '<br>');
        },

        sendSuggestion(text) {
            this.inputMessage = text;
            this.sendMessage();
        },

        sendMessage() {
            var message = this.inputMessage.trim();
            if (!message || this.loading) return;

            this.error = '';
            this.inputMessage = '';

            // Add user message
            this.messages.push({ role: 'user', content: message });
            this.saveMessages();
            this.$nextTick(() => { this.scrollToBottom(); });

            this.loading = true;

            var csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
            var self = this;

            // Build history from existing messages (exclude the one we just pushed)
            var history = this.messages.slice(0, -1).map(function(m) {
                return { role: m.role, content: m.content };
            });

            fetch('/api/ai-chat/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                },
                body: JSON.stringify({
                    message: message,
                    history: history
                })
            })
            .then(function(response) {
                return response.json().then(function(data) {
                    return { ok: response.ok, data: data };
                });
            })
            .then(function(result) {
                self.loading = false;
                if (!result.ok) {
                    self.error = result.data.error || 'An error occurred.';
                    if (result.data.upgrade) {
                        self.error = result.data.error;
                    }
                    return;
                }

                // Add assistant reply
                self.messages.push({ role: 'assistant', content: result.data.reply });
                self.remaining = result.data.remaining;
                self.saveMessages();
                self.$nextTick(function() { self.scrollToBottom(); });
            })
            .catch(function(err) {
                self.loading = false;
                self.error = 'Network error. Please check your connection and try again.';
            });
        },

        clearChat() {
            this.messages = [];
            this.error = '';
            localStorage.removeItem('writingbot_ai_chat');
        }
    };
}
</script>
{% endblock %}
