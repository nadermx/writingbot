{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="container py-4" style="max-width: 896px;">
    <!-- Header -->
    <div class="text-center mb-4">
        <h1 class="display-5 fw-bold text-dark">AI Chat</h1>
        <p class="mt-2 text-muted">Chat with an AI writing assistant. Get help with brainstorming, grammar, outlines, and more.</p>
    </div>

    {% csrf_token %}

    <div x-data="aiChat()" x-cloak>

        <!-- Usage Badge -->
        <div class="d-flex justify-content-center mb-3">
            {% if not is_premium %}
            <div class="d-inline-flex align-items-center gap-2 px-3 py-1 bg-light rounded-pill small text-secondary">
                <svg style="width:16px;height:16px" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>
                <span x-text="remaining >= 0 ? remaining + ' / {{ limit }} messages today' : 'Unlimited'"></span>
            </div>
            {% else %}
            <div class="d-inline-flex align-items-center gap-2 px-3 py-1 bg-brand-50 rounded-pill small text-brand">
                <svg style="width:16px;height:16px" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>
                Premium - Unlimited messages
            </div>
            {% endif %}
        </div>

        <!-- Chat Container -->
        <div class="card shadow-sm rounded-4 overflow-hidden d-flex flex-column" style="height: 600px;">

            <!-- Messages Area -->
            <div class="flex-grow-1 overflow-auto p-3" id="chat-messages" x-ref="messagesContainer">

                <!-- Welcome Message -->
                <div x-show="messages.length === 0" class="d-flex flex-column align-items-center justify-content-center h-100 text-center px-3">
                    <div class="bg-brand-50 rounded-4 d-flex align-items-center justify-content-center mb-3" style="width:64px;height:64px;">
                        <svg style="width:32px;height:32px" class="text-brand" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/></svg>
                    </div>
                    <h3 class="fs-5 fw-semibold text-dark mb-2">How can I help you write today?</h3>
                    <p class="text-muted small mb-4" style="max-width: 28rem;">Ask me to brainstorm ideas, improve your writing, explain grammar rules, create outlines, or anything else writing-related.</p>

                    <!-- Suggestion Chips -->
                    <div class="d-flex flex-wrap justify-content-center gap-2">
                        <button @click="sendSuggestion('Help me brainstorm ideas for a blog post about productivity')"
                                class="btn btn-light btn-sm text-body">
                            Brainstorm blog ideas
                        </button>
                        <button @click="sendSuggestion('Explain the difference between active and passive voice')"
                                class="btn btn-light btn-sm text-body">
                            Grammar help
                        </button>
                        <button @click="sendSuggestion('Create an outline for a research paper about climate change')"
                                class="btn btn-light btn-sm text-body">
                            Create an outline
                        </button>
                        <button @click="sendSuggestion('How can I make my writing more engaging and less boring?')"
                                class="btn btn-light btn-sm text-body">
                            Improve my writing
                        </button>
                    </div>
                </div>

                <!-- Message Bubbles -->
                <template x-for="(msg, index) in messages" :key="index">
                    <div :class="msg.role === 'user' ? 'd-flex justify-content-end mb-3' : 'd-flex justify-content-start mb-3'">
                        <div :class="msg.role === 'user'
                            ? 'bg-brand text-white rounded-4 px-3 py-2'
                            : 'bg-light text-dark rounded-4 px-3 py-2'"
                            style="max-width:80%;border-bottom-right-radius:0.375rem !important;"
                            :style="msg.role !== 'user' ? 'border-bottom-left-radius:0.375rem !important;border-bottom-right-radius:var(--bs-border-radius-xl) !important;' : ''">
                            <!-- User messages: plain text -->
                            <div x-show="msg.role === 'user'" class="small" style="line-height:1.6;white-space:pre-wrap;" x-text="msg.content"></div>
                            <!-- Assistant messages: rendered markdown -->
                            <div x-show="msg.role === 'assistant'" class="small" style="line-height:1.6;" x-html="renderMarkdown(msg.content)"></div>
                        </div>
                    </div>
                </template>

                <!-- Typing Indicator -->
                <div x-show="loading" class="d-flex justify-content-start mb-3">
                    <div class="bg-light rounded-4 px-3 py-2" style="border-bottom-left-radius:0.375rem !important;">
                        <div class="d-flex gap-1 align-items-center">
                            <div class="bg-secondary rounded-circle animate-bounce" style="width:8px;height:8px;opacity:0.5;animation-delay:0ms;"></div>
                            <div class="bg-secondary rounded-circle animate-bounce" style="width:8px;height:8px;opacity:0.5;animation-delay:150ms;"></div>
                            <div class="bg-secondary rounded-circle animate-bounce" style="width:8px;height:8px;opacity:0.5;animation-delay:300ms;"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Error Message -->
            <div x-show="error" class="px-3 py-2 border-top" style="background-color:#fef2f2;border-color:#fee2e2 !important;">
                <p class="small text-danger mb-0" x-text="error"></p>
            </div>

            <!-- Input Area -->
            <div class="border-top p-3 bg-light">
                <div class="d-flex gap-3 align-items-end">
                    <div class="flex-grow-1 position-relative">
                        <textarea
                            x-model="inputMessage"
                            @keydown.enter.prevent="if (!$event.shiftKey) sendMessage()"
                            @input="autoResize($event.target)"
                            placeholder="Type your message... (Shift+Enter for new line)"
                            rows="1"
                            class="form-control rounded-3"
                            style="max-height: 120px; resize: none; overflow: hidden;"
                            :disabled="loading"
                        ></textarea>
                    </div>
                    <button
                        @click="sendMessage()"
                        :disabled="loading || !inputMessage.trim()"
                        class="btn btn-brand flex-shrink-0 d-flex align-items-center justify-content-center rounded-3"
                        style="width:44px;height:44px;"
                    >
                        <svg x-show="!loading" style="width:20px;height:20px" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/></svg>
                        <svg x-show="loading" style="width:20px;height:20px" class="animate-spin" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                    </button>
                </div>
                <div class="d-flex justify-content-between align-items-center mt-2">
                    <button @click="clearChat()" x-show="messages.length > 0"
                            class="btn btn-link btn-sm text-secondary text-decoration-none p-0" style="font-size:0.75rem;">
                        Clear conversation
                    </button>
                    <span style="font-size:0.75rem;" class="text-secondary">Press Enter to send</span>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- Marked.js for Markdown rendering -->
<script src="https://cdn.jsdelivr.net/npm/marked@12/marked.min.js"></script>
<script>
function aiChat() {
    return {
        inputMessage: '',
        messages: [],
        loading: false,
        error: '',
        remaining: {{ remaining }},

        init() {
            // Restore conversation from localStorage
            var saved = localStorage.getItem('writingbot_ai_chat');
            if (saved) {
                try {
                    this.messages = JSON.parse(saved);
                } catch (e) {
                    this.messages = [];
                }
            }
            this.$nextTick(() => { this.scrollToBottom(); });
        },

        saveMessages() {
            try {
                // Keep only last 50 messages in storage
                var toSave = this.messages.slice(-50);
                localStorage.setItem('writingbot_ai_chat', JSON.stringify(toSave));
            } catch (e) {
                // Storage full, clear old data
                localStorage.removeItem('writingbot_ai_chat');
            }
        },

        scrollToBottom() {
            var container = this.$refs.messagesContainer;
            if (container) {
                container.scrollTop = container.scrollHeight;
            }
        },

        autoResize(el) {
            el.style.height = 'auto';
            el.style.height = Math.min(el.scrollHeight, 120) + 'px';
        },

        renderMarkdown(text) {
            if (!text) return '';
            try {
                if (typeof marked !== 'undefined') {
                    return marked.parse(text);
                }
            } catch (e) {}
            // Fallback: escape HTML and convert newlines to <br>
            return text.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/\n/g, '<br>');
        },

        sendSuggestion(text) {
            this.inputMessage = text;
            this.sendMessage();
        },

        sendMessage() {
            var message = this.inputMessage.trim();
            if (!message || this.loading) return;

            this.error = '';
            this.inputMessage = '';

            // Add user message
            this.messages.push({ role: 'user', content: message });
            this.saveMessages();
            this.$nextTick(() => { this.scrollToBottom(); });

            this.loading = true;

            var csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
            var self = this;

            // Build history from existing messages (exclude the one we just pushed)
            var history = this.messages.slice(0, -1).map(function(m) {
                return { role: m.role, content: m.content };
            });

            fetch('/api/ai-chat/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                },
                body: JSON.stringify({
                    message: message,
                    history: history
                })
            })
            .then(function(response) {
                return response.json().then(function(data) {
                    return { ok: response.ok, data: data };
                });
            })
            .then(function(result) {
                self.loading = false;
                if (!result.ok) {
                    self.error = result.data.error || 'An error occurred.';
                    if (result.data.upgrade) {
                        self.error = result.data.error;
                    }
                    return;
                }

                // Add assistant reply
                self.messages.push({ role: 'assistant', content: result.data.reply });
                self.remaining = result.data.remaining;
                self.saveMessages();
                self.$nextTick(function() { self.scrollToBottom(); });
            })
            .catch(function(err) {
                self.loading = false;
                self.error = 'Network error. Please check your connection and try again.';
            });
        },

        clearChat() {
            this.messages = [];
            this.error = '';
            localStorage.removeItem('writingbot_ai_chat');
        }
    };
}
</script>
{% endblock %}
