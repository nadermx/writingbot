{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="container-fluid px-4 py-4" x-data="grammarChecker()" x-init="init()">
    {% csrf_token %}

    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12 text-center">
            <h1 class="h2 fw-bold">{{ g.i18n.grammar_checker|default:"Grammar Checker" }}</h1>
            <p class="text-muted">{{ g.i18n.grammar_checker_desc|default:"Fix grammar, spelling, and punctuation errors with AI-powered analysis" }}</p>
        </div>
    </div>

    <!-- Dialect Selector -->
    <div class="row mb-3">
        <div class="col-12 col-md-6">
            <div class="d-flex align-items-center gap-2">
                <label class="form-label mb-0 text-muted small">Dialect:</label>
                <select x-model="dialect" class="form-select form-select-sm" style="width: auto;">
                    <option value="en-us">English (US)</option>
                    <option value="en-gb">English (UK)</option>
                    <option value="en-au">English (AU)</option>
                    <option value="en-ca">English (CA)</option>
                </select>
            </div>
        </div>
        <div class="col-12 col-md-6 text-end">
            <span class="text-muted small" x-text="wordCount + ' / {{ word_limit }} words'"></span>
            {% if not is_premium %}
            <a href="/pricing/" class="btn btn-sm btn-outline-primary ms-2">Upgrade</a>
            {% endif %}
        </div>
    </div>

    <!-- Main Editor Area -->
    <div class="row">
        <!-- Text Editor -->
        <div class="col-12 col-lg-8 mb-4">
            <div class="card shadow-sm h-100">
                <div class="card-body p-0">
                    <!-- Editor with highlighted errors -->
                    <div class="position-relative" style="min-height: 400px;">
                        <!-- Highlight layer (behind textarea) -->
                        <div
                            class="position-absolute top-0 start-0 w-100 h-100 p-3"
                            style="pointer-events: none; white-space: pre-wrap; word-wrap: break-word; font-family: inherit; font-size: 1rem; line-height: 1.6; color: transparent; overflow: auto;"
                            x-html="highlightedHtml"
                        ></div>
                        <!-- Textarea -->
                        <textarea
                            x-model="text"
                            @input="onTextInput()"
                            class="form-control border-0 h-100"
                            style="min-height: 400px; resize: vertical; background: transparent; position: relative; z-index: 1; font-size: 1rem; line-height: 1.6;"
                            :placeholder="'{{ g.i18n.grammar_placeholder|default:"Paste or type your text here to check for grammar errors..." }}'"
                        ></textarea>
                    </div>
                </div>
                <div class="card-footer bg-white border-top d-flex justify-content-between align-items-center flex-wrap gap-2">
                    <div class="d-flex gap-2 align-items-center">
                        <span class="badge bg-light text-dark" x-text="wordCount + ' words'"></span>
                        <span class="badge bg-light text-dark" x-text="charCount + ' characters'"></span>
                        <template x-if="readabilityScore !== null">
                            <span class="badge bg-light text-dark" x-text="'Readability: ' + readabilityScore"></span>
                        </template>
                    </div>
                    <div class="d-flex gap-2">
                        <button
                            @click="checkGrammar()"
                            :disabled="loading || !text.trim()"
                            class="btn btn-primary"
                        >
                            <span x-show="loading" class="spinner-border spinner-border-sm me-1"></span>
                            <span x-text="loading ? 'Checking...' : '{{ g.i18n.check_grammar|default:"Check Grammar" }}'"></span>
                        </button>
                        <template x-if="corrections.length > 0">
                            <button
                                @click="fixAll()"
                                :disabled="fixingAll"
                                class="btn btn-success"
                            >
                                <span x-show="fixingAll" class="spinner-border spinner-border-sm me-1"></span>
                                <span x-text="fixingAll ? 'Fixing...' : '{{ g.i18n.fix_all_errors|default:"Fix All Errors" }} (' + corrections.length + ')'"></span>
                            </button>
                        </template>
                    </div>
                </div>
            </div>
        </div>

        <!-- Sidebar: Scores + Corrections -->
        <div class="col-12 col-lg-4 mb-4">
            <!-- Writing Scores -->
            <div class="card shadow-sm mb-3">
                <div class="card-header bg-white fw-semibold">
                    <span>{{ g.i18n.writing_score|default:"Writing Score" }}</span>
                </div>
                <div class="card-body">
                    <template x-if="!hasScores">
                        <p class="text-muted text-center small mb-0">Check your text to see writing scores</p>
                    </template>
                    <template x-if="hasScores">
                        <div>
                            <!-- Score circles -->
                            <div class="d-flex flex-wrap justify-content-center gap-3 mb-3">
                                <template x-for="(label, key) in scoreLabels" :key="key">
                                    <div class="text-center">
                                        <div class="position-relative d-inline-flex align-items-center justify-content-center" style="width: 64px; height: 64px;">
                                            <svg width="64" height="64" viewBox="0 0 64 64">
                                                <circle cx="32" cy="32" r="28" fill="none" stroke="#e9ecef" stroke-width="4"/>
                                                <circle
                                                    cx="32" cy="32" r="28" fill="none"
                                                    :stroke="getScoreColor(scores[key])"
                                                    stroke-width="4"
                                                    stroke-linecap="round"
                                                    :stroke-dasharray="(2 * Math.PI * 28)"
                                                    :stroke-dashoffset="(2 * Math.PI * 28) * (1 - (scores[key] || 0) / 100)"
                                                    transform="rotate(-90 32 32)"
                                                    style="transition: stroke-dashoffset 0.6s ease;"
                                                />
                                            </svg>
                                            <span class="position-absolute fw-bold small" x-text="scores[key] || 0"></span>
                                        </div>
                                        <div class="small text-muted mt-1" x-text="label"></div>
                                    </div>
                                </template>
                            </div>

                            <!-- Tone indicator -->
                            <div class="mb-2">
                                <label class="small text-muted mb-1 d-block">Tone</label>
                                <div class="d-flex align-items-center gap-2">
                                    <span class="small">Formal</span>
                                    <div class="flex-grow-1 position-relative" style="height: 8px; background: linear-gradient(to right, #3b82f6, #8b5cf6, #f59e0b); border-radius: 4px;">
                                        <div
                                            class="position-absolute bg-white border border-2 rounded-circle"
                                            style="width: 16px; height: 16px; top: -4px; transition: left 0.3s ease;"
                                            :style="'left: ' + tonePosition + '%'"
                                        ></div>
                                    </div>
                                    <span class="small">Casual</span>
                                </div>
                            </div>
                        </div>
                    </template>
                </div>
            </div>

            <!-- Error List -->
            <div class="card shadow-sm">
                <div class="card-header bg-white fw-semibold d-flex justify-content-between align-items-center">
                    <span>{{ g.i18n.corrections|default:"Corrections" }}</span>
                    <span class="badge bg-danger rounded-pill" x-show="corrections.length > 0" x-text="corrections.length"></span>
                </div>
                <div class="card-body p-0" style="max-height: 500px; overflow-y: auto;">
                    <template x-if="corrections.length === 0 && !loading">
                        <p class="text-muted text-center small p-3 mb-0">
                            <span x-show="!hasChecked">Check your text to see corrections</span>
                            <span x-show="hasChecked">No errors found. Great writing!</span>
                        </p>
                    </template>

                    <!-- Grouped by type -->
                    <template x-for="(group, gIdx) in groupedCorrections" :key="gIdx">
                        <div class="border-bottom">
                            <div class="px-3 py-2 bg-light d-flex justify-content-between align-items-center">
                                <span class="small fw-semibold text-capitalize" x-text="formatType(group.type)"></span>
                                <span class="badge rounded-pill" :class="getTypeBadgeClass(group.type)" x-text="group.items.length"></span>
                            </div>
                            <template x-for="(correction, cIdx) in group.items" :key="cIdx">
                                <div class="px-3 py-2 border-top correction-item" style="cursor: pointer;" @click="scrollToError(correction)">
                                    <div class="d-flex justify-content-between align-items-start mb-1">
                                        <span class="text-decoration-line-through text-danger small" x-text="correction.original"></span>
                                        <button
                                            @click.stop="applySingle(correction)"
                                            class="btn btn-sm btn-outline-success ms-2 py-0 px-1"
                                            title="Apply fix"
                                        >
                                            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" viewBox="0 0 16 16">
                                                <path d="M13.854 3.646a.5.5 0 0 1 0 .708l-7 7a.5.5 0 0 1-.708 0l-3.5-3.5a.5.5 0 1 1 .708-.708L6.5 10.293l6.646-6.647a.5.5 0 0 1 .708 0z"/>
                                            </svg>
                                        </button>
                                    </div>
                                    <div class="text-success small fw-semibold" x-text="correction.suggestion"></div>
                                    <div class="text-muted small mt-1" x-text="correction.explanation"></div>
                                </div>
                            </template>
                        </div>
                    </template>
                </div>
            </div>
        </div>
    </div>

    <!-- Error alert -->
    <template x-if="errorMessage">
        <div class="row">
            <div class="col-12">
                <div class="alert alert-danger alert-dismissible fade show" role="alert">
                    <span x-text="errorMessage"></span>
                    <button type="button" class="btn-close" @click="errorMessage = null"></button>
                </div>
            </div>
        </div>
    </template>
</div>

<!-- Related Tools -->
<div class="bg-light py-5">
    <div class="container">
        <h2 class="text-center fw-bold mb-4">Related Writing Tools</h2>
        <div class="row g-3 justify-content-center">
            <div class="col-6 col-md-4 col-lg-3">
                <a href="/proofreader/" class="d-block text-decoration-none text-dark p-3 rounded bg-white shadow-sm text-center h-100">
                    <div class="fw-semibold small mb-1">Proofreader</div>
                    <div class="text-muted" style="font-size: 0.75rem;">Professional proofreading</div>
                </a>
            </div>
            <div class="col-6 col-md-4 col-lg-3">
                <a href="/spell-checker/" class="d-block text-decoration-none text-dark p-3 rounded bg-white shadow-sm text-center h-100">
                    <div class="fw-semibold small mb-1">Spell Checker</div>
                    <div class="text-muted" style="font-size: 0.75rem;">Fix spelling errors</div>
                </a>
            </div>
            <div class="col-6 col-md-4 col-lg-3">
                <a href="/punctuation-checker/" class="d-block text-decoration-none text-dark p-3 rounded bg-white shadow-sm text-center h-100">
                    <div class="fw-semibold small mb-1">Punctuation Checker</div>
                    <div class="text-muted" style="font-size: 0.75rem;">Fix punctuation errors</div>
                </a>
            </div>
            <div class="col-6 col-md-4 col-lg-3">
                <a href="/essay-checker/" class="d-block text-decoration-none text-dark p-3 rounded bg-white shadow-sm text-center h-100">
                    <div class="fw-semibold small mb-1">Essay Checker</div>
                    <div class="text-muted" style="font-size: 0.75rem;">Check essays for errors</div>
                </a>
            </div>
        </div>
        <h3 class="text-center fw-semibold mt-5 mb-3">Grammar Checkers by Language</h3>
        <div class="row g-2 justify-content-center">
            <div class="col-6 col-md-4 col-lg-3"><a href="/german-grammar-check/" class="d-block text-decoration-none text-dark p-2 rounded bg-white border text-center small">German Grammar Check</a></div>
            <div class="col-6 col-md-4 col-lg-3"><a href="/french-grammar-check/" class="d-block text-decoration-none text-dark p-2 rounded bg-white border text-center small">French Grammar Check</a></div>
            <div class="col-6 col-md-4 col-lg-3"><a href="/spanish-grammar-check/" class="d-block text-decoration-none text-dark p-2 rounded bg-white border text-center small">Spanish Grammar Check</a></div>
            <div class="col-6 col-md-4 col-lg-3"><a href="/portuguese-grammar-check/" class="d-block text-decoration-none text-dark p-2 rounded bg-white border text-center small">Portuguese Grammar Check</a></div>
            <div class="col-6 col-md-4 col-lg-3"><a href="/dutch-grammar-check/" class="d-block text-decoration-none text-dark p-2 rounded bg-white border text-center small">Dutch Grammar Check</a></div>
            <div class="col-6 col-md-4 col-lg-3"><a href="/italian-grammar-check/" class="d-block text-decoration-none text-dark p-2 rounded bg-white border text-center small">Italian Grammar Check</a></div>
            <div class="col-6 col-md-4 col-lg-3"><a href="/polish-grammar-check/" class="d-block text-decoration-none text-dark p-2 rounded bg-white border text-center small">Polish Grammar Check</a></div>
            <div class="col-6 col-md-4 col-lg-3"><a href="/swedish-grammar-check/" class="d-block text-decoration-none text-dark p-2 rounded bg-white border text-center small">Swedish Grammar Check</a></div>
            <div class="col-6 col-md-4 col-lg-3"><a href="/russian-grammar-check/" class="d-block text-decoration-none text-dark p-2 rounded bg-white border text-center small">Russian Grammar Check</a></div>
            <div class="col-6 col-md-4 col-lg-3"><a href="/japanese-grammar-check/" class="d-block text-decoration-none text-dark p-2 rounded bg-white border text-center small">Japanese Grammar Check</a></div>
        </div>
    </div>
</div>

<!-- Why Use Section -->
<div class="bg-light py-5">
    <div class="container">
        <h2 class="text-center fw-bold mb-5">Why Use Our Grammar Checker</h2>
        <div class="row g-4">
            <div class="col-md-4">
                <div class="card h-100 border-0 shadow-sm p-4">
                    <h5 class="fw-semibold mb-3">AI-Powered Analysis</h5>
                    <p class="text-muted mb-0">Our grammar checker uses advanced AI to catch errors that simple spell-checkers miss, including subject-verb agreement, misplaced modifiers, comma splices, and style issues.</p>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card h-100 border-0 shadow-sm p-4">
                    <h5 class="fw-semibold mb-3">Writing Scores & Tone</h5>
                    <p class="text-muted mb-0">Get scores for clarity, engagement, delivery, and correctness. See a visual tone indicator showing whether your writing is formal or casual.</p>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card h-100 border-0 shadow-sm p-4">
                    <h5 class="fw-semibold mb-3">Grouped Error Categories</h5>
                    <p class="text-muted mb-0">Errors are organized by type, including grammar, spelling, punctuation, style, and clarity, so you can focus on the areas that need the most improvement.</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- How to Use Section -->
<div class="container py-5">
    <h2 class="text-center fw-bold mb-5">How to Use Grammar Checker</h2>
    <div class="row g-4 justify-content-center">
        <div class="col-md-4 text-center">
            <div class="rounded-circle bg-primary text-white d-inline-flex align-items-center justify-content-center mb-3" style="width:48px;height:48px;font-size:1.25rem;font-weight:700;">1</div>
            <h5 class="fw-semibold">Paste or Type Text</h5>
            <p class="text-muted">Enter your text in the editor. Select your English dialect (US, UK, AU, or CA) for region-specific grammar rules.</p>
        </div>
        <div class="col-md-4 text-center">
            <div class="rounded-circle bg-primary text-white d-inline-flex align-items-center justify-content-center mb-3" style="width:48px;height:48px;font-size:1.25rem;font-weight:700;">2</div>
            <h5 class="fw-semibold">Click Check Grammar</h5>
            <p class="text-muted">The AI analyzes your text and highlights errors with suggestions grouped by category. Review each correction with clear explanations.</p>
        </div>
        <div class="col-md-4 text-center">
            <div class="rounded-circle bg-primary text-white d-inline-flex align-items-center justify-content-center mb-3" style="width:48px;height:48px;font-size:1.25rem;font-weight:700;">3</div>
            <h5 class="fw-semibold">Fix All or One by One</h5>
            <p class="text-muted">Apply individual fixes by clicking the checkmark, or fix everything at once with the Fix All Errors button.</p>
        </div>
    </div>
</div>

<!-- FAQ Section -->
<div class="container py-5">
    <h2 class="text-center fw-bold mb-5">Frequently Asked Questions</h2>
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="accordion" id="faqAccordion">
                <div class="accordion-item border-0 mb-2">
                    <h3 class="accordion-header">
                        <button class="accordion-button fw-semibold" type="button" data-bs-toggle="collapse" data-bs-target="#faq1">
                            What types of errors does it detect?
                        </button>
                    </h3>
                    <div id="faq1" class="accordion-collapse collapse show" data-bs-parent="#faqAccordion">
                        <div class="accordion-body text-muted">
                            Our grammar checker catches grammar errors (subject-verb agreement, tense consistency, misplaced modifiers), spelling mistakes, punctuation errors (commas, semicolons, apostrophes), style issues (passive voice, wordiness, repetition), and clarity problems (ambiguous phrasing, overly complex sentences).
                        </div>
                    </div>
                </div>
                <div class="accordion-item border-0 mb-2">
                    <h3 class="accordion-header">
                        <button class="accordion-button collapsed fw-semibold" type="button" data-bs-toggle="collapse" data-bs-target="#faq2">
                            Which English dialects are supported?
                        </button>
                    </h3>
                    <div id="faq2" class="accordion-collapse collapse" data-bs-parent="#faqAccordion">
                        <div class="accordion-body text-muted">
                            We support American English (US), British English (UK), Australian English (AU), and Canadian English (CA). Select your dialect in the dropdown to get region-specific suggestions, like "color" vs "colour" or "realize" vs "realise."
                        </div>
                    </div>
                </div>
                <div class="accordion-item border-0 mb-2">
                    <h3 class="accordion-header">
                        <button class="accordion-button collapsed fw-semibold" type="button" data-bs-toggle="collapse" data-bs-target="#faq3">
                            What do the writing scores mean?
                        </button>
                    </h3>
                    <div id="faq3" class="accordion-collapse collapse" data-bs-parent="#faqAccordion">
                        <div class="accordion-body text-muted">
                            The writing scores rate your text on four dimensions: Clarity (how easy it is to understand), Engagement (how interesting and compelling), Delivery (tone and voice consistency), and Correctness (grammar and spelling accuracy). Each is scored from 0 to 100.
                        </div>
                    </div>
                </div>
                <div class="accordion-item border-0 mb-2">
                    <h3 class="accordion-header">
                        <button class="accordion-button collapsed fw-semibold" type="button" data-bs-toggle="collapse" data-bs-target="#faq4">
                            How does the tone indicator work?
                        </button>
                    </h3>
                    <div id="faq4" class="accordion-collapse collapse" data-bs-parent="#faqAccordion">
                        <div class="accordion-body text-muted">
                            The tone indicator analyzes your writing style on a spectrum from Formal to Casual. It considers factors like sentence length, vocabulary complexity, use of contractions, and overall voice. This helps you ensure your writing matches your intended audience.
                        </div>
                    </div>
                </div>
                <div class="accordion-item border-0 mb-2">
                    <h3 class="accordion-header">
                        <button class="accordion-button collapsed fw-semibold" type="button" data-bs-toggle="collapse" data-bs-target="#faq5">
                            What is the word limit?
                        </button>
                    </h3>
                    <div id="faq5" class="accordion-collapse collapse" data-bs-parent="#faqAccordion">
                        <div class="accordion-body text-muted">
                            Free users can check up to 1,200 words per request. Premium subscribers get extended word limits for longer documents and priority AI processing.
                        </div>
                    </div>
                </div>
                <div class="accordion-item border-0 mb-2">
                    <h3 class="accordion-header">
                        <button class="accordion-button collapsed fw-semibold" type="button" data-bs-toggle="collapse" data-bs-target="#faq6">
                            Is it better than Grammarly?
                        </button>
                    </h3>
                    <div id="faq6" class="accordion-collapse collapse" data-bs-parent="#faqAccordion">
                        <div class="accordion-body text-muted">
                            Our grammar checker offers many of the same features, including contextual grammar checking, writing scores, and tone analysis, but within an integrated platform that also includes paraphrasing, summarizing, translation, and 90+ AI writing tools. The best tool depends on your specific needs.
                        </div>
                    </div>
                </div>
                <div class="accordion-item border-0 mb-2">
                    <h3 class="accordion-header">
                        <button class="accordion-button collapsed fw-semibold" type="button" data-bs-toggle="collapse" data-bs-target="#faq7">
                            Can I check grammar in other languages?
                        </button>
                    </h3>
                    <div id="faq7" class="accordion-collapse collapse" data-bs-parent="#faqAccordion">
                        <div class="accordion-body text-muted">
                            Yes, we offer dedicated grammar checkers for German, French, Spanish, Portuguese, Dutch, Italian, Polish, Swedish, Russian, and Japanese. Visit the specific language page for grammar checking optimized for that language.
                        </div>
                    </div>
                </div>
                <div class="accordion-item border-0 mb-2">
                    <h3 class="accordion-header">
                        <button class="accordion-button collapsed fw-semibold" type="button" data-bs-toggle="collapse" data-bs-target="#faq8">
                            How do I use the Fix All Errors button?
                        </button>
                    </h3>
                    <div id="faq8" class="accordion-collapse collapse" data-bs-parent="#faqAccordion">
                        <div class="accordion-body text-muted">
                            After the grammar check completes, click Fix All Errors to apply every suggested correction at once. The number in parentheses shows how many fixes will be applied. You can also fix individual errors by clicking the checkmark next to each suggestion.
                        </div>
                    </div>
                </div>
                <div class="accordion-item border-0 mb-2">
                    <h3 class="accordion-header">
                        <button class="accordion-button collapsed fw-semibold" type="button" data-bs-toggle="collapse" data-bs-target="#faq9">
                            Does it check for plagiarism too?
                        </button>
                    </h3>
                    <div id="faq9" class="accordion-collapse collapse" data-bs-parent="#faqAccordion">
                        <div class="accordion-body text-muted">
                            No, the grammar checker focuses on grammar, spelling, punctuation, and style errors. For plagiarism detection, use our dedicated Plagiarism Checker tool, which scans your text against billions of web pages.
                        </div>
                    </div>
                </div>
                <div class="accordion-item border-0 mb-2">
                    <h3 class="accordion-header">
                        <button class="accordion-button collapsed fw-semibold" type="button" data-bs-toggle="collapse" data-bs-target="#faq10">
                            Is it free to use?
                        </button>
                    </h3>
                    <div id="faq10" class="accordion-collapse collapse" data-bs-parent="#faqAccordion">
                        <div class="accordion-body text-muted">
                            Yes, the grammar checker is free for all users with a per-request word limit. Premium subscribers get extended word limits and faster processing. No account is required to use the basic grammar checking features.
                        </div>
                    </div>
                </div>
                <div class="accordion-item border-0 mb-2">
                    <h3 class="accordion-header">
                        <button class="accordion-button collapsed fw-semibold" type="button" data-bs-toggle="collapse" data-bs-target="#faq11">
                            Can I check academic papers?
                        </button>
                    </h3>
                    <div id="faq11" class="accordion-collapse collapse" data-bs-parent="#faqAccordion">
                        <div class="accordion-body text-muted">
                            Yes. Select Academic English mode, and the checker pays special attention to formal grammar rules, proper citation formatting hints, and academic style conventions. It is especially useful for essays, research papers, and dissertations.
                        </div>
                    </div>
                </div>
                <div class="accordion-item border-0 mb-2">
                    <h3 class="accordion-header">
                        <button class="accordion-button collapsed fw-semibold" type="button" data-bs-toggle="collapse" data-bs-target="#faq12">
                            Does it work on mobile?
                        </button>
                    </h3>
                    <div id="faq12" class="accordion-collapse collapse" data-bs-parent="#faqAccordion">
                        <div class="accordion-body text-muted">
                            Yes, the grammar checker is fully responsive and works on all mobile devices and tablets. The error list and correction suggestions are optimized for smaller screens so you can check your writing on the go.
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="{% static 'js/grammar.js' %}?v={{ g.scripts_version }}"></script>
{% endblock %}
