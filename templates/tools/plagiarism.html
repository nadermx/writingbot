{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="container py-4" x-data="plagiarismApp()" x-cloak>
    {% csrf_token %}

    <!-- Header -->
    <div class="text-center mb-4">
        <h1 class="fw-bold mb-2">Plagiarism Checker</h1>
        <p class="text-muted">Scan your writing against billions of web pages for originality.</p>
    </div>

    {% if not is_premium %}
    <!-- Premium Gate -->
    <div class="card shadow-sm border-0 mb-4">
        <div class="card-body text-center py-5">
            <div class="mb-3">
                <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" fill="currentColor" class="text-primary" viewBox="0 0 16 16">
                    <path d="M8 1a2 2 0 0 1 2 2v4H6V3a2 2 0 0 1 2-2m3 6V3a3 3 0 0 0-6 0v4a2 2 0 0 0-2 2v5a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2"/>
                </svg>
            </div>
            <h3 class="fw-bold mb-3">Premium Feature</h3>
            <p class="text-muted mb-4 mx-auto" style="max-width: 500px;">
                The Plagiarism Checker is available exclusively for premium subscribers.
                Scan up to 30,000 words per month and get detailed originality reports.
            </p>

            <div class="row justify-content-center mb-4">
                <div class="col-md-8">
                    <div class="row g-3 text-start">
                        <div class="col-sm-6">
                            <div class="d-flex align-items-start">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="text-success mt-1 me-2 flex-shrink-0" viewBox="0 0 16 16">
                                    <path d="M13.854 3.646a.5.5 0 0 1 0 .708l-7 7a.5.5 0 0 1-.708 0l-3.5-3.5a.5.5 0 1 1 .708-.708L6.5 10.293l6.646-6.647a.5.5 0 0 1 .708 0"/>
                                </svg>
                                <span>30,000 words per month</span>
                            </div>
                        </div>
                        <div class="col-sm-6">
                            <div class="d-flex align-items-start">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="text-success mt-1 me-2 flex-shrink-0" viewBox="0 0 16 16">
                                    <path d="M13.854 3.646a.5.5 0 0 1 0 .708l-7 7a.5.5 0 0 1-.708 0l-3.5-3.5a.5.5 0 1 1 .708-.708L6.5 10.293l6.646-6.647a.5.5 0 0 1 .708 0"/>
                                </svg>
                                <span>Billions of web sources</span>
                            </div>
                        </div>
                        <div class="col-sm-6">
                            <div class="d-flex align-items-start">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="text-success mt-1 me-2 flex-shrink-0" viewBox="0 0 16 16">
                                    <path d="M13.854 3.646a.5.5 0 0 1 0 .708l-7 7a.5.5 0 0 1-.708 0l-3.5-3.5a.5.5 0 1 1 .708-.708L6.5 10.293l6.646-6.647a.5.5 0 0 1 .708 0"/>
                                </svg>
                                <span>Detailed match reports</span>
                            </div>
                        </div>
                        <div class="col-sm-6">
                            <div class="d-flex align-items-start">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="text-success mt-1 me-2 flex-shrink-0" viewBox="0 0 16 16">
                                    <path d="M13.854 3.646a.5.5 0 0 1 0 .708l-7 7a.5.5 0 0 1-.708 0l-3.5-3.5a.5.5 0 1 1 .708-.708L6.5 10.293l6.646-6.647a.5.5 0 0 1 .708 0"/>
                                </svg>
                                <span>Source URL identification</span>
                            </div>
                        </div>
                        <div class="col-sm-6">
                            <div class="d-flex align-items-start">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="text-success mt-1 me-2 flex-shrink-0" viewBox="0 0 16 16">
                                    <path d="M13.854 3.646a.5.5 0 0 1 0 .708l-7 7a.5.5 0 0 1-.708 0l-3.5-3.5a.5.5 0 1 1 .708-.708L6.5 10.293l6.646-6.647a.5.5 0 0 1 .708 0"/>
                                </svg>
                                <span>Highlighted matching text</span>
                            </div>
                        </div>
                        <div class="col-sm-6">
                            <div class="d-flex align-items-start">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="text-success mt-1 me-2 flex-shrink-0" viewBox="0 0 16 16">
                                    <path d="M13.854 3.646a.5.5 0 0 1 0 .708l-7 7a.5.5 0 0 1-.708 0l-3.5-3.5a.5.5 0 1 1 .708-.708L6.5 10.293l6.646-6.647a.5.5 0 0 1 .708 0"/>
                                </svg>
                                <span>Export reports</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <a href="/pricing/?lang={{ g.lang.iso }}" class="btn btn-primary btn-lg px-5">
                Upgrade to Premium
            </a>
        </div>
    </div>

    {% else %}
    <!-- Premium User: Plagiarism Checker Tool -->

    <!-- Monthly Usage Bar -->
    <div class="card shadow-sm mb-4">
        <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <span class="fw-semibold">Monthly Usage</span>
                <span class="text-muted">
                    <span x-text="usage.words_used.toLocaleString()">{{ usage.words_used }}</span>
                    / <span x-text="usage.words_limit.toLocaleString()">{{ usage.words_limit }}</span> words
                </span>
            </div>
            <div class="progress" style="height: 8px;">
                <div class="progress-bar"
                     :class="usagePercent > 90 ? 'bg-danger' : usagePercent > 70 ? 'bg-warning' : 'bg-success'"
                     role="progressbar"
                     :style="'width: ' + usagePercent + '%'"
                     :aria-valuenow="usagePercent"
                     aria-valuemin="0" aria-valuemax="100"></div>
            </div>
            <small class="text-muted" x-text="usage.words_remaining.toLocaleString() + ' words remaining this month'"></small>
        </div>
    </div>

    <!-- Text Input -->
    <div class="card shadow-sm mb-4">
        <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <label class="form-label fw-semibold mb-0">Enter your text</label>
                <div>
                    <label class="btn btn-sm btn-outline-secondary mb-0">
                        Upload File
                        <input type="file" class="d-none" accept=".txt,.doc,.docx,.pdf" @change="handleFileUpload($event)">
                    </label>
                </div>
            </div>
            <textarea class="form-control" rows="12"
                      placeholder="Paste or type your text here to check for plagiarism..."
                      x-model="inputText"
                      @input="updateWordCount()"></textarea>
            <div class="d-flex justify-content-between align-items-center mt-2">
                <small class="text-muted"><span x-text="wordCount">0</span> words</small>
                <small class="text-muted" x-show="wordCount > 0 && wordCount < 15">Minimum 15 words required</small>
            </div>
        </div>
    </div>

    <!-- Error message -->
    <div x-show="errorMsg" class="alert alert-danger alert-dismissible mb-4" role="alert">
        <span x-text="errorMsg"></span>
        <button type="button" class="btn-close" @click="errorMsg = ''"></button>
    </div>

    <!-- Check Button -->
    <div class="text-center mb-4">
        <button class="btn btn-primary btn-lg px-5"
                @click="checkPlagiarism()"
                :disabled="checking || wordCount < 15">
            <span x-show="!checking">Check Plagiarism</span>
            <span x-show="checking">
                <span class="spinner-border spinner-border-sm me-1" role="status"></span>Scanning...
            </span>
        </button>
    </div>

    <!-- Results -->
    <div x-show="result" x-transition>
        <!-- Similarity Gauge -->
        <div class="card shadow-sm mb-4">
            <div class="card-body text-center py-4">
                <h5 class="fw-semibold mb-3">Overall Similarity</h5>
                <div class="position-relative d-inline-block mb-3" style="width: 160px; height: 160px;">
                    <svg viewBox="0 0 36 36" class="w-100 h-100" style="transform: rotate(-90deg);">
                        <path d="M18 2.0845
                            a 15.9155 15.9155 0 0 1 0 31.831
                            a 15.9155 15.9155 0 0 1 0 -31.831"
                            fill="none"
                            stroke="#e9ecef"
                            stroke-width="3"/>
                        <path d="M18 2.0845
                            a 15.9155 15.9155 0 0 1 0 31.831
                            a 15.9155 15.9155 0 0 1 0 -31.831"
                            fill="none"
                            :stroke="gaugeColor"
                            stroke-width="3"
                            :stroke-dasharray="result.similarity_percentage + ', 100'"
                            stroke-linecap="round"/>
                    </svg>
                    <div class="position-absolute top-50 start-50 translate-middle text-center">
                        <span class="fs-2 fw-bold" :style="'color:' + gaugeColor"
                              x-text="result.similarity_percentage + '%'"></span>
                    </div>
                </div>
                <div>
                    <span class="badge fs-6 px-3 py-2"
                          :class="result.similarity_percentage <= 10 ? 'bg-success' :
                                  result.similarity_percentage <= 30 ? 'bg-warning text-dark' : 'bg-danger'"
                          x-text="result.similarity_percentage <= 10 ? 'Low Similarity - Looks Original' :
                                  result.similarity_percentage <= 30 ? 'Moderate Similarity' : 'High Similarity - Review Needed'">
                    </span>
                </div>
                <p class="text-muted mt-2 mb-0">
                    <span x-text="result.word_count"></span> words checked |
                    <span x-text="result.matches.length"></span> sources found
                </p>
            </div>
        </div>

        <!-- Highlighted Text with Matches -->
        <div class="card shadow-sm mb-4" x-show="result.matches.length > 0">
            <div class="card-header bg-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Matching Passages</h5>
                <button class="btn btn-sm btn-outline-secondary" @click="exportReport()">Export Report</button>
            </div>
            <div class="card-body">
                <div class="bg-light rounded p-3 mb-3" style="max-height: 300px; overflow-y: auto;">
                    <div x-html="highlightedText"></div>
                </div>
            </div>
        </div>

        <!-- Source List -->
        <div class="card shadow-sm mb-4" x-show="result.matches.length > 0">
            <div class="card-header bg-white">
                <h5 class="mb-0">Sources Found</h5>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>#</th>
                                <th>Source</th>
                                <th>Matched Text</th>
                                <th class="text-end">Similarity</th>
                            </tr>
                        </thead>
                        <tbody>
                            <template x-for="(match, idx) in result.matches" :key="idx">
                                <tr>
                                    <td x-text="idx + 1"></td>
                                    <td style="max-width: 250px;">
                                        <a :href="match.source_url" target="_blank" rel="noopener noreferrer"
                                           class="text-decoration-none text-truncate d-block"
                                           x-text="match.title || match.source_url" :title="match.source_url"></a>
                                        <small class="text-muted text-truncate d-block" x-text="match.source_url" style="max-width: 250px;"></small>
                                    </td>
                                    <td style="max-width: 300px;">
                                        <small class="text-muted" x-text="match.matched_text.substring(0, 150) + (match.matched_text.length > 150 ? '...' : '')"></small>
                                    </td>
                                    <td class="text-end">
                                        <span class="badge"
                                              :class="match.similarity_percent <= 30 ? 'bg-warning text-dark' : 'bg-danger'"
                                              x-text="match.similarity_percent + '%'"></span>
                                    </td>
                                </tr>
                            </template>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- No matches found -->
        <div class="card shadow-sm mb-4" x-show="result && result.matches.length === 0">
            <div class="card-body text-center py-4">
                <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" fill="currentColor" class="text-success mb-3" viewBox="0 0 16 16">
                    <path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0m-3.97-3.03a.75.75 0 0 0-1.08.022L7.477 9.417 5.384 7.323a.75.75 0 0 0-1.06 1.06L6.97 11.03a.75.75 0 0 0 1.079-.02l3.992-4.99a.75.75 0 0 0-.01-1.05z"/>
                </svg>
                <h5 class="fw-semibold">No Plagiarism Detected</h5>
                <p class="text-muted mb-0">Your text appears to be original. No matching sources were found.</p>
            </div>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
<script>
    {% if is_premium and usage %}
    window.__plagiarismUsage = {
        words_used: {{ usage.words_used }},
        words_limit: {{ usage.words_limit }},
        words_remaining: {{ usage.words_remaining }}
    };
    {% endif %}
</script>
<script src="{% static 'js/plagiarism.js' %}?v={{ g.scripts_version }}"></script>
{% endblock %}
