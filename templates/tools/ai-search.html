{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="container py-4" style="max-width: 896px;">
    <!-- Header -->
    <div class="text-center mb-4">
        <h1 class="display-5 fw-bold text-dark">AI Search</h1>
        <p class="mt-2 text-muted">Get comprehensive, AI-synthesized answers with source references</p>
    </div>

    {% csrf_token %}

    <div x-data="aiSearch()" x-cloak>

        <!-- Usage Badge -->
        <div class="d-flex justify-content-center mb-4">
            {% if not is_premium %}
            <div class="d-inline-flex align-items-center gap-2 px-3 py-1 bg-light rounded-pill small text-secondary">
                <svg style="width:16px;height:16px" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
                <span x-text="remaining >= 0 ? remaining + ' / {{ limit }} searches today' : 'Unlimited'"></span>
            </div>
            {% else %}
            <div class="d-inline-flex align-items-center gap-2 px-3 py-1 bg-brand-50 rounded-pill small text-brand">
                <svg style="width:16px;height:16px" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>
                Premium - Unlimited searches
            </div>
            {% endif %}
        </div>

        <!-- Search Bar -->
        <div class="position-relative mb-5">
            <div class="d-flex gap-3">
                <div class="flex-grow-1 position-relative">
                    <div class="position-absolute top-50 translate-middle-y" style="left:16px;pointer-events:none;">
                        <svg style="width:20px;height:20px" class="text-secondary" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
                    </div>
                    <input
                        type="text"
                        x-model="query"
                        @keydown.enter="search()"
                        placeholder="Ask anything... e.g., 'What are the best practices for writing a cover letter?'"
                        class="form-control form-control-lg rounded-3 shadow-sm"
                        style="padding-left: 48px;"
                        :disabled="loading"
                    >
                </div>
                <button
                    @click="search()"
                    :disabled="loading || !query.trim()"
                    class="btn btn-brand flex-shrink-0 d-flex align-items-center gap-2 rounded-3 shadow-sm fw-medium px-4"
                >
                    <span x-show="!loading">Search</span>
                    <span x-show="loading" class="d-flex align-items-center gap-2">
                        <svg style="width:16px;height:16px" class="animate-spin" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                        Researching...
                    </span>
                </button>
            </div>

            <!-- Suggestion Chips -->
            <div x-show="!hasResult && !loading" class="d-flex flex-wrap gap-2 mt-3 justify-content-center">
                <button @click="searchSuggestion('How to write an effective thesis statement')"
                        class="btn btn-light btn-sm text-secondary" style="font-size:0.75rem;">
                    Thesis statement tips
                </button>
                <button @click="searchSuggestion('What is the difference between MLA and APA citation styles?')"
                        class="btn btn-light btn-sm text-secondary" style="font-size:0.75rem;">
                    MLA vs APA
                </button>
                <button @click="searchSuggestion('Best strategies for overcoming writer\'s block')"
                        class="btn btn-light btn-sm text-secondary" style="font-size:0.75rem;">
                    Writer's block solutions
                </button>
                <button @click="searchSuggestion('How to structure a persuasive essay')"
                        class="btn btn-light btn-sm text-secondary" style="font-size:0.75rem;">
                    Persuasive essay structure
                </button>
                <button @click="searchSuggestion('What are common grammar mistakes in English?')"
                        class="btn btn-light btn-sm text-secondary" style="font-size:0.75rem;">
                    Common grammar mistakes
                </button>
            </div>
        </div>

        <!-- Error Message -->
        <div x-show="error" class="mb-4 p-3 rounded-3" style="background-color:#fef2f2;border:1px solid #fee2e2;">
            <p class="small text-danger mb-0" x-text="error"></p>
        </div>

        <!-- Loading Skeleton -->
        <div x-show="loading">
            <div class="card shadow-sm rounded-4 p-4 mb-3">
                <div class="placeholder-glow">
                    <div class="placeholder bg-secondary rounded mb-3" style="width:75%;height:16px;display:block;"></div>
                    <div class="placeholder bg-secondary rounded mb-3" style="width:100%;height:16px;display:block;"></div>
                    <div class="placeholder bg-secondary rounded mb-3" style="width:83%;height:16px;display:block;"></div>
                    <div class="placeholder bg-secondary rounded mb-3" style="width:100%;height:16px;display:block;"></div>
                    <div class="placeholder bg-secondary rounded mb-4" style="width:66%;height:16px;display:block;"></div>
                    <div class="placeholder bg-secondary rounded mb-3" style="width:100%;height:12px;display:block;"></div>
                    <div class="placeholder bg-secondary rounded mb-3" style="width:80%;height:12px;display:block;"></div>
                    <div class="placeholder bg-secondary rounded mb-3" style="width:100%;height:12px;display:block;"></div>
                    <div class="placeholder bg-secondary rounded" style="width:75%;height:12px;display:block;"></div>
                </div>
            </div>
        </div>

        <!-- Results -->
        <div x-show="hasResult && !loading">

            <!-- Query Display -->
            <div class="d-flex align-items-center gap-2 mb-3">
                <span class="small text-muted">Results for:</span>
                <span class="small fw-medium text-dark" x-text="lastQuery"></span>
            </div>

            <!-- Answer Card -->
            <div class="card shadow-sm rounded-4 overflow-hidden mb-4">
                <div class="px-4 py-3 border-bottom bg-brand-50">
                    <div class="d-flex align-items-center gap-2">
                        <div class="bg-brand rounded-3 d-flex align-items-center justify-content-center" style="width:24px;height:24px;">
                            <svg style="width:14px;height:14px" class="text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>
                        </div>
                        <span class="small fw-semibold text-dark">AI-Generated Answer</span>
                    </div>
                </div>
                <div class="p-4">
                    <div class="small text-body" style="line-height:1.6;" x-html="renderMarkdown(answer)"></div>
                </div>

                <!-- Copy Button -->
                <div class="px-4 py-2 bg-light border-top d-flex justify-content-between align-items-center">
                    <span style="font-size:0.75rem;" class="text-secondary">AI-generated content. Verify important facts independently.</span>
                    <button @click="copyAnswer()" class="btn btn-outline-secondary btn-sm d-inline-flex align-items-center gap-1" style="font-size:0.75rem;">
                        <svg x-show="!copied" style="width:14px;height:14px" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3"/></svg>
                        <span x-text="copied ? 'Copied!' : 'Copy'"></span>
                    </button>
                </div>
            </div>

            <!-- Sources Section -->
            <div x-show="sources.length > 0" class="mb-4">
                <h3 class="small fw-semibold text-dark mb-3 d-flex align-items-center gap-2">
                    <svg style="width:16px;height:16px" class="text-muted" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"/></svg>
                    References
                </h3>
                <div class="d-grid gap-3">
                    <template x-for="(source, index) in sources" :key="index">
                        <div class="d-flex align-items-start gap-3 p-3 bg-white border rounded-3">
                            <div class="flex-shrink-0 bg-light rounded-circle d-flex align-items-center justify-content-center" style="width:24px;height:24px;">
                                <span class="fw-medium text-muted" style="font-size:0.75rem;" x-text="index + 1"></span>
                            </div>
                            <div>
                                <h4 class="small fw-medium text-dark mb-0" x-text="source.title"></h4>
                                <p class="text-muted mt-1 mb-0" style="font-size:0.75rem;" x-text="source.snippet"></p>
                            </div>
                        </div>
                    </template>
                </div>
            </div>

            <!-- Search Again -->
            <div class="text-center">
                <button @click="clearResults()" class="btn btn-link btn-sm text-muted text-decoration-none">
                    Search something else
                </button>
            </div>
        </div>

        <!-- Search History -->
        <div x-show="!hasResult && !loading && searchHistory.length > 0" class="mt-5">
            <div class="d-flex align-items-center justify-content-between mb-3">
                <h3 class="small fw-semibold text-body mb-0">Recent Searches</h3>
                <button @click="clearHistory()" class="btn btn-link btn-sm text-secondary text-decoration-none p-0" style="font-size:0.75rem;">Clear</button>
            </div>
            <div class="d-grid gap-2">
                <template x-for="(item, index) in searchHistory.slice(0, 5)" :key="index">
                    <button @click="searchSuggestion(item)" class="btn btn-outline-light text-start d-flex align-items-center gap-3 px-3 py-2 border rounded-3 text-body">
                        <svg style="width:16px;height:16px" class="text-secondary flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                        <span class="small text-body text-truncate" x-text="item"></span>
                    </button>
                </template>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- Marked.js for Markdown rendering -->
<script src="https://cdn.jsdelivr.net/npm/marked@12/marked.min.js"></script>
<script>
function aiSearch() {
    return {
        query: '',
        lastQuery: '',
        answer: '',
        sources: [],
        loading: false,
        error: '',
        hasResult: false,
        copied: false,
        remaining: {{ remaining }},
        searchHistory: [],

        init() {
            // Restore search history from localStorage
            var saved = localStorage.getItem('writingbot_ai_search_history');
            if (saved) {
                try {
                    this.searchHistory = JSON.parse(saved);
                } catch (e) {
                    this.searchHistory = [];
                }
            }
        },

        saveHistory(q) {
            // Add to front, deduplicate, limit to 10
            this.searchHistory = [q].concat(
                this.searchHistory.filter(function(item) { return item !== q; })
            ).slice(0, 10);
            try {
                localStorage.setItem('writingbot_ai_search_history', JSON.stringify(this.searchHistory));
            } catch (e) {}
        },

        renderMarkdown(text) {
            if (!text) return '';
            try {
                if (typeof marked !== 'undefined') {
                    return marked.parse(text);
                }
            } catch (e) {}
            return text.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/\n/g, '<br>');
        },

        searchSuggestion(text) {
            this.query = text;
            this.search();
        },

        search() {
            var q = this.query.trim();
            if (!q || this.loading) return;

            this.error = '';
            this.loading = true;
            this.hasResult = false;
            this.answer = '';
            this.sources = [];
            this.lastQuery = q;

            var csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
            var self = this;

            fetch('/api/ai-search/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                },
                body: JSON.stringify({ query: q })
            })
            .then(function(response) {
                return response.json().then(function(data) {
                    return { ok: response.ok, data: data };
                });
            })
            .then(function(result) {
                self.loading = false;
                if (!result.ok) {
                    self.error = result.data.error || 'An error occurred.';
                    return;
                }

                self.answer = result.data.answer;
                self.sources = result.data.sources || [];
                self.remaining = result.data.remaining;
                self.hasResult = true;
                self.saveHistory(q);
            })
            .catch(function(err) {
                self.loading = false;
                self.error = 'Network error. Please check your connection and try again.';
            });
        },

        copyAnswer() {
            var self = this;
            // Strip HTML tags for plain text copy
            var temp = document.createElement('div');
            temp.innerHTML = this.renderMarkdown(this.answer);
            var plainText = temp.textContent || temp.innerText || '';

            navigator.clipboard.writeText(plainText).then(function() {
                self.copied = true;
                setTimeout(function() {
                    self.copied = false;
                }, 2000);
            });
        },

        clearResults() {
            this.hasResult = false;
            this.answer = '';
            this.sources = [];
            this.query = '';
            this.lastQuery = '';
            this.error = '';
        },

        clearHistory() {
            this.searchHistory = [];
            localStorage.removeItem('writingbot_ai_search_history');
        }
    };
}
</script>
{% endblock %}
